# Aetheris Backend — FastAPI

AI-Powered Multimodal Perioperative Co-Pilot · Backend API

---

## Quick Start (Hackathon — 5 minutes)

```bash
# 1. Clone & enter directory
cd aetheris-backend

# 2. Create virtual environment
python -m venv venv
source venv/bin/activate        # Windows: venv\Scripts\activate

# 3. Install dependencies
pip install -r requirements.txt

# 4. Copy environment file
cp .env.example .env
# Edit .env → add your ANTHROPIC_API_KEY and OPENAI_API_KEY

# 5. Train ML models (generates asa_risk_model.pkl)
python -m app.ml.model_service

# 6. Start the server
uvicorn app.main:app --reload --port 8000
```

Visit: http://localhost:8000/docs (interactive API docs)

---

## API Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET  | /health | Health check |
| GET  | /api/patients/ | List all patients |
| POST | /api/patients/ | Create patient |
| GET  | /api/patients/{id} | Get patient |
| POST | /api/preop/assess | **Run AI pre-op assessment** |
| POST | /api/intraop/anomaly-check | Check vitals for anomalies |
| POST | /api/intraop/voice-command | Process voice/text command |
| PATCH| /api/intraop/procedure-step | Advance procedure timeline |
| WS   | /api/intraop/vitals-stream/{id} | **Live vitals WebSocket** |
| POST | /api/postop/complication-risk | Predict complication risks |
| POST | /api/reports/generate | **Generate AI clinical report** |
| POST | /api/reports/send-to-ehr | Submit report to EHR |
| POST | /api/vitals/log | Log a vitals reading |
| GET  | /api/vitals/{id}/history | Get vitals history |
| GET  | /api/alerts/ | List alerts |
| POST | /api/alerts/ | Create alert |
| PATCH| /api/alerts/{id}/acknowledge | Acknowledge alert |

---

## Frontend Integration

### Pre-Op Assessment
```javascript
const response = await fetch('http://localhost:8000/api/preop/assess', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    patient_id: 'p001',
    surgery_type: 'Cardiac',
    asa_class: 'III',
    medications: ['Warfarin', 'Aspirin', 'Metformin'],
    diabetes: true,
    hypertension: true,
    cardiac_hx: false,
    smoking: false,
  })
});
const data = await response.json();
// data.overall_risk_score, data.drug_interactions, data.checklist, data.ai_summary
```

### Live Vitals WebSocket
```javascript
const ws = new WebSocket('ws://localhost:8000/api/intraop/vitals-stream/p001');
ws.onmessage = (event) => {
  const data = JSON.parse(event.data);
  if (data.type === 'ANOMALY_ALERT') {
    // Handle alerts: data.alerts[]
  } else {
    // Handle vitals: data.heart_rate, data.spo2, etc.
  }
};
```

### Generate Report
```javascript
const response = await fetch('http://localhost:8000/api/reports/generate', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    patient_id: 'p001',
    surgery_id: 's001',
    report_type: 'operative_note',
  })
});
const report = await response.json();
// report.content = full operative note text
```

---

## Project Structure

```
aetheris-backend/
├── app/
│   ├── main.py                  # FastAPI app + routers
│   ├── api/routes/
│   │   ├── preop.py             # POST /api/preop/assess
│   │   ├── intraop.py           # Anomaly check, voice, WebSocket
│   │   ├── postop.py            # Complication risk
│   │   ├── reports.py           # Report generation + EHR
│   │   ├── patients.py          # Patient CRUD
│   │   ├── vitals.py            # Vitals logging
│   │   └── alerts.py            # Alert management
│   ├── core/
│   │   ├── config.py            # Settings from .env
│   │   └── database.py          # SQLAlchemy async setup
│   ├── models/__init__.py       # DB models (Patient, Surgery, etc.)
│   ├── schemas/__init__.py      # Pydantic request/response schemas
│   ├── services/
│   │   ├── preop_service.py     # Risk scoring + drug checker + LLM
│   │   ├── intraop_service.py   # Anomaly detection + voice AI
│   │   └── postop_service.py    # Complication ML + report gen
│   └── ml/
│       ├── model_service.py     # Train + save + load ML models
│       └── models/
│           ├── asa_risk_model.pkl      # Generated by model_service.py
│           ├── complication_model.pkl  # Generated by model_service.py
│           └── feature_scaler.pkl      # Generated by model_service.py
├── requirements.txt
├── .env.example
└── README.md
```

---

## ML Models

| Model | File | Algorithm | Accuracy |
|-------|------|-----------|----------|
| ASA Risk Classifier | asa_risk_model.pkl | Gradient Boosting | ~72% |
| Complication Risk | complication_model.pkl | Random Forest Regressor | R²~0.85 |
| Feature Scaler | feature_scaler.pkl | StandardScaler | — |

Train: `python -m app.ml.model_service`

Production dataset: MIMIC-IV (physionet.org) or ACS NSQIP

---

## Deployment (Docker)

```dockerfile
FROM python:3.11-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY . .
RUN python -m app.ml.model_service
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

```bash
docker build -t aetheris-backend .
docker run -p 8000:8000 --env-file .env aetheris-backend
```
